<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection System</title>
    <style>

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1710d0 0%, #2fbaec 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-content {
    text-align: center;
    flex: 1;
}

.user-info {
    background: rgba(102, 126, 234, 0.1);
    padding: 10px 20px;
    border-radius: 25px;
    color: #4a5568;
    font-weight: 600;
}

h1 {
    color: #4a5568;
    font-size: 2.5em;
    margin-bottom: 10px;
}

.subtitle {
    color: #718096;
    font-size: 1.1em;
}

.nav-tabs {
    display: flex;
    justify-content: center;
    margin: 30px 0;
    gap: 10px;
}

.tab-button {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
    font-weight: 500;
    position: relative;
}

.tab-button:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.tab-button.active {
    background: white;
    color: #4a5568;
}

.alert-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e53e3e;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.tab-content {
    display: none;
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    animation: fadeIn 0.5s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #4a5568;
}

input, select, textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #1710d0;
}

.btn {
    background: linear-gradient(135deg, #1710d0 0%, #30c2f7 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    margin: 10px 5px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
}

.btn-small {
    padding: 6px 15px;
    font-size: 14px;
    margin: 5px 2px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.transactions-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.transactions-table th,
.transactions-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.transactions-table th {
    background: #f7fafc;
    font-weight: 600;
    color: #4a5568;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.status-normal {
    background: #c6f6d5;
    color: #22543d;
}

.status-suspicious {
    background: #fed7d7;
    color: #742a2a;
}

.status-flagged {
    background: #fed7d7;
    color: #742a2a;
}

.alert-box {
    background: #fed7d7;
    border: 1px solid #fc8181;
    color: #742a2a;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.success-box {
    background: #c6f6d5;
    border: 1px solid #68d391;
    color: #22543d;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.warning-box {
    background: #fef5e7;
    border: 1px solid #f6ad55;
    color: #744210;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.info-box {
    background: #e6fffa;
    border: 1px solid #4fd1c7;
    color: #234e52;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #4a5568;
}

.stat-label {
    color: #718096;
    margin-top: 5px;
}

.fraud-analysis {
    margin-top: 15px;
    padding: 15px;
    border-radius: 8px;
}

.alert-card {
    background: white;
    border-left: 4px solid #e53e3e;
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.alert-card.critical {
    border-left-color: #e53e3e;
    background: #fef5f5;
}

.alert-card.high {
    border-left-color: #f6ad55;
    background: #fffbf5;
}

.alert-card.medium {
    border-left-color: #4299e1;
    background: #f7faff;
}

.alert-card.low {
    border-left-color: #68d391;
    background: #f0fff4;
}

.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.alert-title {
    font-weight: bold;
    font-size: 1.1em;
}

.alert-meta {
    font-size: 0.9em;
    color: #718096;
    margin-bottom: 10px;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 400px;
}

.notification.show {
    transform: translateX(0);
}

.notification.alert {
    border-left: 4px solid #e53e3e;
    background: #fef5f5;
}

.notification.info {
    border-left: 4px solid #4299e1;
    background: #f7faff;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #718096;
}

.loading::after {
    content: '...';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

.logout-btn {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.3);
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
}

.logout-btn:hover {
    background: rgba(231, 76, 60, 0.2);
    transform: translateY(-1px);
}

.category-limits-container {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f1f5f9;
}

.category-item:last-child {
    border-bottom: none;
}

.category-name {
    font-weight: 500;
    color: #4a5568;
    flex: 1;
}

.category-limit {
    display: flex;
    align-items: center;
    gap: 10px;
}

.limit-input {
    width: 120px;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.limit-input:focus {
    outline: none;
    border-color: #1710d0;
}

.currency-symbol {
    color: #718096;
    font-weight: 500;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .nav-tabs {
        flex-wrap: wrap;
    }
    
    h1 {
        font-size: 2em;
    }
    
    .alert-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    header {
        flex-direction: column;
        gap: 15px;
    }
    
    .category-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .category-limit {
        width: 100%;
        justify-content: space-between;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1> Fraud Detection System</h1>
                <p class="subtitle">Monitor and protect your financial transactions</p>
            </div>
            <div class="user-info">
                <span id="currentUserDisplay">üë§ Loading...</span>
                <a href="index.html" class="logout-btn">üö™ Logout</a>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="transactions">My Transactions</button>
            <button class="tab-button" data-tab="alerts" id="alertsTab">
                My Alerts
                <span class="alert-badge" id="alertBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button" data-tab="profile">Profile Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>My Account Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="myTransactions">0</div>
                    <div class="stat-label">My Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="myTotalSpent">$0.00</div>
                    <div class="stat-label">Total Amount Spent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="myActiveAlerts">0</div>
                    <div class="stat-label">Active Alerts</div>
                </div>
            </div>
            
            <h3>Account Security Summary</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="myRiskScore">Low</div>
                    <div class="stat-label">Risk Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastTransaction">Never</div>
                    <div class="stat-label">Last Transaction</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="accountStatus">Active</div>
                    <div class="stat-label">Account Status</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                <button class="btn" onclick="refreshMyData()">üîÑ Refresh My Data</button>
                <button class="btn btn-secondary" onclick="createTestTransaction()">üß™ Test Transaction</button>
            </div>
            
            <h3>My Recent Transactions</h3>
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="myRecentTransactions">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #718096; padding: 40px;">
                            <div class="loading">Loading your transactions</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <h2>Add New Transaction</h2>
            
            <form id="transactionForm">
                <div class="form-group">
                    <label for="transactionID">Transaction ID:</label>
                    <input type="text" id="transactionID" name="transactionID" placeholder="e.g., T010" required maxlength="10">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">Amount:</label>
                        <input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="categoryID">Category:</label>
                        <select id="categoryID" name="categoryID" required>
                            <option value="">Select Category</option>
                            <option value="C001">Food & Dining</option>
                            <option value="C002">Electronics</option>
                            <option value="C003">Cosmetics</option>
                            <option value="C004">Bills</option>
                            <option value="C005">Entertainment</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="location">Location:</label>
                        <select id="location" name="location" required>
                            <option value="">Select Location</option>
                            <option value="Istanbul">Istanbul</option>
                            <option value="Ankara">Ankara</option>
                            <option value="ƒ∞zmir">ƒ∞zmir</option>
                            <option value="Bursa">Bursa</option>
                            <option value="Antalya">Antalya</option>
                            <option value="Adana">Adana</option>
                            <option value="Konya">Konya</option>
                            <option value="Gaziantep">Gaziantep</option>
                            <option value="Mersin">Mersin</option>
                            <option value="Diyarbakƒ±r">Diyarbakƒ±r</option>
                            <option value="Kayseri">Kayseri</option>
                            <option value="Eski≈üehir">Eski≈üehir</option>
                            <option value="Urfa">Urfa</option>
                            <option value="Malatya">Malatya</option>
                            <option value="Erzurum">Erzurum</option>
                            <option value="Van">Van</option>
                            <option value="Batman">Batman</option>
                            <option value="Elazƒ±ƒü">Elazƒ±ƒü</option>
                            <option value="Sivas">Sivas</option>
                            <option value="Manisa">Manisa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">Payment Method:</label>
                        <select id="paymentMethod" name="paymentMethod" required>
                            <option value="">Select Method</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn">Add Transaction</button>
                <button type="reset" class="btn btn-secondary">Clear Form</button>
            </form>

            <div id="transactionMessage"></div>

            <h3>All My Transactions</h3>
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="allMyTransactions">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #718096; padding: 40px;">
                            <div class="loading">Loading your transaction history</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

       <!-- Enhanced Alerts Tab -->
       <div id="alerts" class="tab-content">
        <h2>My Security Alerts</h2>
        
        <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
            <button class="btn" onclick="loadMyAlerts()">üîÑ Refresh My Alerts</button>
            <button class="btn btn-secondary" onclick="createTestAlert()">üß™ Create Test Alert</button>
        </div>
        
        <!-- Alert Statistics -->
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-number" id="totalAlerts">0</div>
                <div class="stat-label">Total Alerts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentAlerts">0</div>
                <div class="stat-label">Last 24 Hours</div>
            </div>
        </div>
        
        <!-- Active Alerts Section -->
        <h3>üö® Active Alerts</h3>
        <div id="alertsContainer">
            <div class="loading">Loading your alerts...</div>
        </div>
        
        <!-- Alert History Table -->
        <h3>üìà Alert History</h3>
        <table class="transactions-table" style="margin-top: 20px;">
            <thead>
                <tr>
                    <th>Alert ID</th>
                    <th>Transaction ID</th>
                    <th>Risk Level</th>
                    <th>Anomaly Type</th>
                    <th>Amount</th>
                
                </tr>
            </thead>
            <tbody id="alertsHistoryBody">
                <tr>
                    <td colspan="7" style="text-align: center; color: #718096; padding: 40px;">
                        <div class="loading">Loading alert history</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

        <!-- Profile Settings Tab -->
        <div id="profile" class="tab-content">
            <h2>My Profile & Security Settings</h2>
            
            <h3>Account Information</h3>
            <div id="profileInfo" class="info-box">
                <p><strong>User ID:</strong> <span id="displayUserID">Loading...</span></p>
                <p><strong>Total Transactions:</strong> <span id="displayTotalTransactions">Loading...</span></p>
                <p><strong>Account Status:</strong> <span id="displayAccountStatus">Loading...</span></p>
            </div>

            <h3>Security Settings</h3>
            <form id="profileForm">
                <input type="hidden" id="profileUserID" name="profileUserID">
                <div class="form-row">
                    <div class="form-group">
                        <label for="avgMonthlySpend">Average Monthly Spend:</label>
                        <input type="number" id="avgMonthlySpend" name="avgMonthlySpend" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="timeWindows">Usual Transaction Times:</label>
                        <input type="text" id="timeWindows" name="timeWindows" placeholder="09:00-22:00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Category Spending Limits:</label>
                    <div class="category-limits-container">
                        <div class="category-item">
                            <span class="category-name">üçΩÔ∏è Food & Dining</span>
                            <div class="category-limit">
                                <span class="currency-symbol">‚Ç∫</span>
                                <input type="number" class="limit-input" id="limit-C001" data-category="C001" placeholder="Set your limit" step="0.01">
                            </div>
                        </div>
                        <div class="category-item">
                            <span class="category-name">üì± Electronics</span>
                            <div class="category-limit">
                                <span class="currency-symbol">‚Ç∫</span>
                                <input type="number" class="limit-input" id="limit-C002" data-category="C002" placeholder="Set your limit" step="0.01">
                            </div>
                        </div>
                        <div class="category-item">
                            <span class="category-name">üíÑ Cosmetics</span>
                            <div class="category-limit">
                                <span class="currency-symbol">‚Ç∫</span>
                                <input type="number" class="limit-input" id="limit-C003" data-category="C003" placeholder="Set your limit" step="0.01">
                            </div>
                        </div>
                        <div class="category-item">
                            <span class="category-name">üßæ Bills</span>
                            <div class="category-limit">
                                <span class="currency-symbol">‚Ç∫</span>
                                <input type="number" class="limit-input" id="limit-C004" data-category="C004" placeholder="Set your limit" step="0.01">
                            </div>
                        </div>
                        <div class="category-item">
                            <span class="category-name">üé¨ Entertainment</span>
                            <div class="category-limit">
                                <span class="currency-symbol">‚Ç∫</span>
                                <input type="number" class="limit-input" id="limit-C005" data-category="C005" placeholder="Set your limit" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="frequentLocations">Frequent Locations:</label>
                    <input type="text" id="frequentLocations" name="frequentLocations" placeholder="Istanbul, Ankara">
                </div>
                
                <button type="submit" class="btn">Update Security Settings</button>
                <button type="reset" class="btn btn-secondary">Reset</button>
            </form>

            <div id="profileMessage"></div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // SIMPLIFIED JAVASCRIPT - ONLY ESSENTIAL FUNCTIONS

        let currentUser = null;
        let alertsData = [];

        // API Configuration
        const API_BASE_URL = (() => {
            const currentHost = window.location.host;
            const currentPath = window.location.pathname;
            
            if (window.location.protocol === 'file:') {
                return 'http://localhost/fraud_detection_system/api.php';
            }
            
            if (currentHost.includes('localhost') || currentHost.includes('127.0.0.1')) {
                const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                return `${window.location.protocol}//${currentHost}${basePath}/api.php`;
            }
            
            return 'http://localhost/fraud_detection_system/api.php';
        })();

        // Initialize current user
        function initializeCurrentUser() {
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                try {
                    const userData = JSON.parse(sessionUser);
                    currentUser = userData.userID;
                } catch (e) {
                    currentUser = sessionUser;
                }
            }
            
            if (!currentUser) {
                const urlParams = new URLSearchParams(window.location.search);
                currentUser = urlParams.get('user');
            }
            
            if (!currentUser) {
                currentUser = localStorage.getItem('currentUser');
            }
            
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            localStorage.setItem('currentUser', currentUser);
            document.getElementById('currentUserDisplay').textContent = `üë§ ${currentUser}`;
            document.getElementById('profileUserID').value = currentUser;
            document.getElementById('displayUserID').textContent = currentUser;
        }

        // API Helper Function
        async function apiCall(endpoint, method = 'GET', data = null) {
            const config = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, config);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'API request failed');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>${type === 'alert' ? 'üö®' : type === 'info' ? '‚ÑπÔ∏è' : '‚úÖ'}</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer; margin-left: auto; font-size: 16px;">‚úï</button>
                </div>
            `;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Category limits functions
        function getCategoryLimitsFromForm() {
            const limits = {};
            const limitInputs = document.querySelectorAll('.limit-input');
            
            limitInputs.forEach(input => {
                const category = input.dataset.category;
                const value = parseFloat(input.value);
                if (!isNaN(value) && value > 0) {
                    limits[category] = value;
                }
            });
            
            return limits;
        }

        function setCategoryLimitsInForm(limits) {
            const limitInputs = document.querySelectorAll('.limit-input');
            
            limitInputs.forEach(input => {
                const category = input.dataset.category;
                if (limits && limits[category]) {
                    input.value = limits[category];
                } else {
                    input.value = '';
                }
            });
        }

        // Load user alerts
        async function loadMyAlerts() {
            try {
                console.log('Loading alerts for user:', currentUser);
                
                const result = await apiCall('alerts');
                const allAlerts = result.data || [];
                
                console.log('All alerts from API:', allAlerts);
                console.log('Total alerts received:', allAlerts.length);
                
                // Filter alerts for current user
                alertsData = allAlerts.filter(alert => {
                    const match = alert.UserID === currentUser || 
                                 alert.UserName === currentUser ||
                                 (alert.UserID && alert.UserID.toString() === currentUser.toString());
                    
                    console.log(`Alert ${alert.AlertID}: UserID=${alert.UserID}, Current User=${currentUser}, Match=${match}`);
                    return match;
                });
                
                console.log(`Found ${alertsData.length} alerts for user ${currentUser}:`, alertsData);
                
                renderMyAlerts();
                updateAlertBadge();
                
                // Updated notification message
                if (alertsData.length > 0) {
                    showNotification(`Found ${alertsData.length} alerts for your account!`, 'alert');
                } else {
                    showNotification('No alerts found for your account.', 'info');
                }
                
            } catch (error) {
                console.error('Failed to load alerts:', error);
                alertsData = [];
                renderMyAlerts();
                updateAlertBadge();
                showNotification('Failed to load alerts: ' + error.message, 'alert');
            }
        }

        // Load user transactions
        async function loadMyTransactions() {
            try {
                const result = await apiCall('transactions');
                const allTransactions = result.data || [];
                
                const transactions = allTransactions.filter(transaction => 
                    transaction.UserID === currentUser || 
                    transaction.TransactionUserID === currentUser ||
                    (transaction.UserID && transaction.UserID.toString() === currentUser.toString())
                );
                
                const userProfile = await getUserProfile();
                let categoryLimits = {};
                if (userProfile && userProfile.CategoryLimits) {
                    try {
                        categoryLimits = JSON.parse(userProfile.CategoryLimits);
                    } catch (e) {
                        categoryLimits = {};
                    }
                }
                
                const recentTbody = document.getElementById('myRecentTransactions');
                const allTbody = document.getElementById('allMyTransactions');
                
                if (transactions.length === 0) {
                    const emptyRow = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #718096; padding: 40px;">
                                No transactions yet. Add your first transaction to get started!
                            </td>
                        </tr>
                    `;
                    recentTbody.innerHTML = emptyRow;
                    allTbody.innerHTML = emptyRow;
                    return;
                }

                transactions.sort((a, b) => new Date(b.Date) - new Date(a.Date));

                const recentTransactions = transactions.slice(0, 5);
                recentTbody.innerHTML = recentTransactions.map(transaction => {
                    return generateTransactionRow(transaction, categoryLimits);
                }).join('');

                allTbody.innerHTML = transactions.map(transaction => {
                    return generateTransactionRow(transaction, categoryLimits);
                }).join('');

                updateMyDashboardStats(transactions);
                
            } catch (error) {
                console.error('Failed to load transactions:', error);
                const errorRow = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #e53e3e; padding: 40px;">
                            Failed to load transactions: ${error.message}<br>
                            <button class="btn btn-small" onclick="loadMyTransactions()">Try Again</button>
                        </td>
                    </tr>
                `;
                document.getElementById('myRecentTransactions').innerHTML = errorRow;
                document.getElementById('allMyTransactions').innerHTML = errorRow;
                showNotification('Failed to load transactions: ' + error.message, 'alert');
            }
        }

        // Generate transaction row
        function generateTransactionRow(transaction, categoryLimits) {
            let statusClass = 'status-normal';
            let statusText = 'Normal';
            
            const amount = parseFloat(transaction.Amount);
            const categoryID = transaction.CategoryID;
            
            if (categoryLimits[categoryID] && amount > categoryLimits[categoryID]) {
                statusClass = 'status-flagged';
                statusText = 'Flagged';
            } else if (alertsData.length > 0 && amount > 5000) {
                statusClass = 'status-suspicious';
                statusText = 'Suspicious';
            }
            
            return `
                <tr>
                    <td>${transaction.TransactionID}</td>
                    <td>‚Ç∫${amount.toFixed(2)}</td>
                    <td>${getCategoryName(transaction.CategoryID)}</td>
                    <td>${transaction.Location}</td>
                    <td>${transaction.Date}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>
            `;
        }

        // Get category name
        function getCategoryName(categoryID) {
            const categoryNames = {
                'C001': 'Food & Dining',
                'C002': 'Electronics', 
                'C003': 'Cosmetics',
                'C004': 'Bills',
                'C005': 'Entertainment'
            };
            return categoryNames[categoryID] || categoryID;
        }

        // Get user profile
        async function getUserProfile() {
            try {
                const result = await apiCall('profiles');
                const profiles = result.data || [];
                return profiles.find(profile => 
                    profile.UserID === currentUser || profile.profileUserID === currentUser
                );
            } catch (error) {
                console.error('Failed to get user profile:', error);
                return null;
            }
        }

        // Update dashboard stats
        function updateMyDashboardStats(transactions) {
            const totalTransactions = transactions.length;
            const totalSpent = transactions.reduce((sum, t) => sum + parseFloat(t.Amount || 0), 0);
            const activeAlerts = alertsData.length;
            
            let riskLevel = 'Low';
            if (activeAlerts > 0) {
                if (activeAlerts >= 3) riskLevel = 'High';
                else if (activeAlerts >= 2) riskLevel = 'Medium';
                else riskLevel = 'Low-Medium';
            }

            let lastTransaction = 'Never';
            if (transactions.length > 0) {
                const lastTxnDate = new Date(transactions[0].Date);
                const now = new Date();
                const diffInDays = Math.floor((now - lastTxnDate) / (1000 * 60 * 60 * 24));
                
                if (diffInDays === 0) lastTransaction = 'Today';
                else if (diffInDays === 1) lastTransaction = 'Yesterday';
                else if (diffInDays < 7) lastTransaction = `${diffInDays} days ago`;
                else if (diffInDays < 30) lastTransaction = `${Math.floor(diffInDays / 7)} weeks ago`;
                else lastTransaction = `${Math.floor(diffInDays / 30)} months ago`;
            }

            document.getElementById('myTransactions').textContent = totalTransactions;
            document.getElementById('myTotalSpent').textContent = `‚Ç∫${totalSpent.toFixed(2)}`;
            document.getElementById('myActiveAlerts').textContent = activeAlerts;
            document.getElementById('myRiskScore').textContent = riskLevel;
            document.getElementById('lastTransaction').textContent = lastTransaction;
            
            const displayTotalTransactionsElement = document.getElementById('displayTotalTransactions');
            if (displayTotalTransactionsElement) {
                displayTotalTransactionsElement.textContent = totalTransactions;
            }
        }

       // Add this function to your JavaScript in the HTML file
// Replace the existing renderMyAlerts function with this updated version

function renderMyAlerts() {
    const container = document.getElementById('alertsContainer');
    const historyBody = document.getElementById('alertsHistoryBody');
    
    console.log('Rendering alerts. alertsData:', alertsData);
    
    // UPDATE ALERT STATISTICS
    updateAlertStatistics();
    
    if (alertsData.length === 0) {
        container.innerHTML = `
            <div class="info-box">
                <h3>üõ°Ô∏è No Security Alerts</h3>
                <p>Great! No suspicious activities detected in your account.</p>
                <p>Your transactions appear to be normal and secure.</p>
            </div>
        `;
        
        // Also update the history table
        if (historyBody) {
            historyBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #718096; padding: 40px;">
                        No alerts in your history. Any suspicious activities will be listed here.
                    </td>
                </tr>
            `;
        }
        return;
    }

    // Render alert cards
    container.innerHTML = alertsData.map(alert => {
        const riskLevel = alert.RiskLevel || 'MEDIUM';
        const riskClass = riskLevel.toLowerCase();
        const timeAgo = getTimeAgo(alert.Timestamp);
        const amount = alert.Amount || 0;
        
        return `
            <div class="alert-card ${riskClass}">
                <div class="alert-header">
                    <div class="alert-title">
                        ${getRiskIcon(riskLevel)} ${alert.AlertType || 'Security Alert'}
                    </div>
                    <div class="status-badge status-suspicious">${riskLevel}</div>
                </div>
                <div class="alert-meta">
                    <strong>Alert ID:</strong> ${alert.AlertID} | 
                    <strong>Amount:</strong> ‚Ç∫${parseFloat(amount).toFixed(2)} |
                    <strong>Time:</strong> ${timeAgo}
                </div>
                <div style="margin: 10px 0;">
                    ${alert.Description || 'Suspicious activity detected in your account.'}
                </div>
            </div>
        `;
    }).join('');

    // Render alert history table
    if (historyBody) {
        historyBody.innerHTML = alertsData.map(alert => {
            const timeAgo = getTimeAgo(alert.Timestamp);
            const riskLevel = alert.RiskLevel || 'MEDIUM';
            const alertType = alert.AlertType || 'Security Alert';
            
            return `
                <tr>
                    <td>${alert.AlertID}</td>
                    <td>${alert.TransactionID || 'N/A'}</td>
                    <td><span class="status-badge status-suspicious">${riskLevel}</span></td>
                    <td>${alertType}</td>
                    <td>‚Ç∫${parseFloat(alert.Amount || 0).toFixed(2)}</td>
                </tr>
            `;
        }).join('');
    }
}

// NEW FUNCTION: Update alert statistics
// Replace the updateAlertStatistics function in your HTML file with this fixed version

function updateAlertStatistics() {
    const totalAlerts = alertsData.length;
    
    // Count alerts from last 24 hours
    const now = new Date();
    const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
    
    const recentAlerts = alertsData.filter(alert => {
        try {
            const alertTime = new Date(alert.Timestamp);
            return alertTime > twentyFourHoursAgo;
        } catch (e) {
            return false;
        }
    }).length;
    
    // Update the statistics display (only for elements that exist)
    const totalAlertsElement = document.getElementById('totalAlerts');
    const recentAlertsElement = document.getElementById('recentAlerts');
    
    if (totalAlertsElement) {
        totalAlertsElement.textContent = totalAlerts;
    }
    
    if (recentAlertsElement) {
        recentAlertsElement.textContent = recentAlerts;
    }
    
    console.log(`Alert Statistics Updated: Total=${totalAlerts}, Recent24h=${recentAlerts}`);
}

        // Create test alert
        async function createTestAlert() {
            try {
                const testTransaction = {
                    transactionID: 'T' + Math.floor(Math.random() * 900 + 100),
                    transactionUserID: currentUser,
                    amount: 15000,
                    categoryID: 'C002',
                    location: 'Istanbul',
                    paymentMethod: 'Credit Card'
                };
                
                const result = await apiCall('transactions', 'POST', testTransaction);
                
                if (result.data.alert_created) {
                    showNotification('üö® Test alert created successfully!', 'alert');
                } else {
                    showNotification('Test transaction created but no alert triggered', 'info');
                }
                
                setTimeout(async () => {
                    await loadMyAlerts();
                    await loadMyTransactions();
                }, 1000);
                
            } catch (error) {
                console.error('Failed to create test alert:', error);
                showNotification('Failed to create test alert: ' + error.message, 'alert');
            }
        }
        // Update alert badge
function updateAlertBadge() {
    const activeAlerts = alertsData.length;
    const badge = document.getElementById('alertBadge');
    
    if (activeAlerts > 0) {
        badge.textContent = activeAlerts > 99 ? '99+' : activeAlerts;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
    
    console.log(`Alert badge updated: ${activeAlerts} alerts`);
}

        // Create test transaction
        async function createTestTransaction() {
            try {
                const testTransaction = {
                    transactionID: 'T' + Math.floor(Math.random() * 900 + 100),
                    transactionUserID: currentUser,
                    amount: Math.floor(Math.random() * 500) + 50,
                    categoryID: 'C001',
                    location: 'Istanbul',
                    paymentMethod: 'Credit Card'
                };
                
                const result = await apiCall('transactions', 'POST', testTransaction);
                showNotification('‚úÖ Test transaction added to your account!', 'info');
                loadMyTransactions();
                
            } catch (error) {
                showNotification('Failed to create test transaction: ' + error.message, 'alert');
            }
        }

        // Helper functions
        function getRiskIcon(riskLevel) {
            switch(riskLevel) {
                case 'CRITICAL': return 'üö®';
                case 'HIGH': return '‚ö†Ô∏è';
                case 'MEDIUM': return 'üîî';
                case 'LOW': return '‚ÑπÔ∏è';
                default: return '‚ÑπÔ∏è';
            }
        }

        function getTimeAgo(timestamp) {
            try {
                if (!timestamp) return 'Unknown time';
                
                const now = new Date();
                const alertTime = new Date(timestamp);
                
                if (isNaN(alertTime.getTime())) {
                    return `Invalid date: ${timestamp}`;
                }
                
                const diffInMinutes = Math.floor((now - alertTime) / (1000 * 60));
                
                if (diffInMinutes < 1) return 'Just now';
                if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
                if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
                return `${Math.floor(diffInMinutes / 1440)}d ago`;
            } catch (error) {
                console.error('Error calculating time ago:', error);
                return `Error: ${timestamp}`;
            }
        }

        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case 'CRITICAL': return '#fed7d7';
                case 'HIGH': return '#fef5e7';
                case 'MEDIUM': return '#e6fffa';
                case 'LOW_MEDIUM': return '#f0fff4';
                default: return '#f7fafc';
            }
        }

        // Refresh data
        async function refreshMyData() {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'üîÑ Refreshing...';
                button.disabled = true;
                
                await loadMyTransactions();
                await loadMyAlerts();
                
                showNotification('Your data has been refreshed!', 'info');
                
                button.textContent = originalText;
                button.disabled = false;
            } catch (error) {
                showNotification('Failed to refresh data: ' + error.message, 'alert');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Load profile
        async function loadMyProfile() {
            try {
                const result = await apiCall('profiles');
                const profiles = result.data || [];
                const myProfile = profiles.find(profile => 
                    profile.UserID === currentUser || profile.profileUserID === currentUser
                );
                
                if (myProfile) {
                    document.getElementById('avgMonthlySpend').value = myProfile.avgMonthlySpend || '';
                    document.getElementById('timeWindows').value = myProfile.timeWindows || '';
                    document.getElementById('frequentLocations').value = myProfile.frequentLocations || '';
                    
                    let categoryLimits = {};
                    if (myProfile.categoryLimits || myProfile.CategoryLimits) {
                        try {
                            categoryLimits = JSON.parse(myProfile.categoryLimits || myProfile.CategoryLimits);
                        } catch (e) {
                            categoryLimits = {};
                        }
                    }
                    setCategoryLimitsInForm(categoryLimits);
                } else {
                    setCategoryLimitsInForm({});
                }
                
                const displayAccountStatusElement = document.getElementById('displayAccountStatus');
                if (displayAccountStatusElement) {
                    displayAccountStatusElement.textContent = 'Active';
                }
                
            } catch (error) {
                console.error('Failed to load profile:', error);
                setCategoryLimitsInForm({});
                
                const displayAccountStatusElement = document.getElementById('displayAccountStatus');
                if (displayAccountStatusElement) {
                    displayAccountStatusElement.textContent = 'Active';
                }
            }
        }

        // Tab management
        function showTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            if (tabName === 'alerts') {
                loadMyAlerts();
            } else if (tabName === 'transactions') {
                loadMyTransactions();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            initializeCurrentUser();
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
            
            showTab('dashboard');
            
            try {
                await loadMyAlerts();
                await loadMyTransactions();
                await loadMyProfile();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    loadMyAlerts().then(() => {
                        loadMyTransactions();
                    });
                }, 30000);
            } catch (error) {
                console.error('Initial load failed:', error);
                showNotification('Failed to load initial data: ' + error.message, 'alert');
            }
        });

        // Form handlers
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const transactionData = Object.fromEntries(formData);
            
            transactionData.transactionUserID = currentUser;
            transactionData.date = new Date().toISOString().split('T')[0];
            transactionData.time = new Date().toTimeString().split(' ')[0];
            
            try {
                const result = await apiCall('transactions', 'POST', transactionData);
                
                let messageHTML = '<div class="success-box">Transaction added successfully!</div>';
                
                if (result.data && result.data.alert_created) {
                    messageHTML += `<div class="warning-box">
                        üö® <strong>Security Alert Generated!</strong><br>
                        ${result.data.alert_message}
                    </div>`;
                    
                    showNotification('üö® Security Alert: Suspicious transaction detected!', 'alert');
                    loadMyAlerts();
                }
                
                if (result.data && result.data.fraud_analysis) {
                    const analysis = result.data.fraud_analysis;
                    const riskColor = getRiskColor(analysis.risk_level);
                    
                    messageHTML += `
                        <div class="fraud-analysis" style="background: ${riskColor};">
                            <h4>üõ°Ô∏è Fraud Detection Results</h4>
                            <p><strong>Risk Level:</strong> ${analysis.risk_level}</p>
                            <p><strong>Risk Score:</strong> ${analysis.risk_score}/100</p>
                            <p><strong>Recommendation:</strong> ${analysis.recommendation}</p>
                            ${analysis.flags && analysis.flags.length > 0 ? `
                                <p><strong>Flags:</strong></p>
                                <ul style="margin-left: 20px;">
                                    ${analysis.flags.map(flag => `<li>${flag}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                }
                
                document.getElementById('transactionMessage').innerHTML = messageHTML;
                
                this.reset();
                loadMyAlerts().then(() => {
                    loadMyTransactions();
                });
                
            } catch (error) {
                document.getElementById('transactionMessage').innerHTML = 
                    `<div class="alert-box">Error: ${error.message}</div>`;
            }
        });

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const profileData = Object.fromEntries(formData);
            
            const categoryLimits = getCategoryLimitsFromForm();
            
            profileData.profileUserID = currentUser;
            profileData.categoryLimits = JSON.stringify(categoryLimits);
            
            try {
                const result = await apiCall('profiles', 'POST', profileData);
                
                document.getElementById('profileMessage').innerHTML = 
                    '<div class="success-box">Profile settings saved successfully!</div>';
                    
                showNotification('Profile settings updated! New category limits are now active.', 'info');
                
                loadMyTransactions();
                    
            } catch (error) {
                document.getElementById('profileMessage').innerHTML = 
                    `<div class="alert-box">Error: ${error.message}</div>`;
            }
        });

        // Auto-generate transaction IDs
        document.getElementById('transactionID').addEventListener('focus', function() {
            if (!this.value) {
                const randomNum = Math.floor(Math.random() * 900) + 100;
                this.value = 'T' + randomNum;
            }
        });

        // Logout functionality
        document.querySelector('.logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('currentUser');
            sessionStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>